<!DOCTYPE html>
<html>
<head>
  <title>Group Chat AI Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
      color: #4A5DF9;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    button {
      background: #4A5DF9;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #3a4dc9; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 8px;
      border-left: 4px solid #4caf50;
    }
    .error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .chat-preview {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
    }
    .message {
      padding: 10px 15px;
      border-radius: 18px;
      max-width: 70%;
      font-size: 14px;
    }
    .message.sender {
      background: #4A5DF9;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .message.recipient-b {
      background: #e0e0e0;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .message.recipient-c {
      background: #f0e6ff;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .person-label {
      font-size: 10px;
      color: #888;
      margin-bottom: 2px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>üß™ Group Chat AI Test</h1>

  <div class="section">
    <h2>Test Configuration</h2>
    <p><strong>Scenario:</strong> 3-person group chat with travel topic</p>
    <p><strong>Pattern:</strong> Simulating a conversation about someone's Tokyo trip</p>
    <p><strong>Structure:</strong></p>
    <pre id="structure-preview"></pre>
  </div>

  <div class="section">
    <h2>Run Test</h2>
    <button id="test-btn" onclick="runTest()">üöÄ Generate Group Chat Conversation</button>
    <button onclick="showPrompt()">üìã Show Full Prompt</button>

    <div id="result"></div>
    <div id="chat-preview" class="chat-preview" style="display: none;"></div>
  </div>

  <div class="section" id="prompt-section" style="display: none;">
    <h2>Full Prompt Sent to Llama</h2>
    <pre id="prompt-content"></pre>
  </div>

  <script>
    // Llama API Key (same as in the plugin)
    const LLAMA_API_KEY = 'LLM|1428288808968195|FSBSdnVSLJIadzuqqUCP-sjT91U';

    // Simulated group chat structure (15 messages)
    // Person A = Sender (you, in Tokyo)
    // Person B = First recipient (Randy)
    // Person C = Second recipient (Verdant)
    const testStructure = [
      { type: 'recipient', person: 'B' },  // Randy starts
      { type: 'recipient', person: 'B' },  // Randy continues
      { type: 'sender', person: 'A' },     // You respond
      { type: 'recipient', person: 'C' },  // Verdant joins
      { type: 'sender', person: 'A' },     // You respond
      { type: 'sender', person: 'A' },     // You continue
      { type: 'recipient', person: 'B' },  // Randy reacts
      { type: 'recipient', person: 'C' },  // Verdant asks
      { type: 'sender', person: 'A' },     // You answer
      { type: 'recipient', person: 'B' },  // Randy suggests
      { type: 'recipient', person: 'C' },  // Verdant agrees
      { type: 'sender', person: 'A' },     // You respond
      { type: 'sender', person: 'A' },     // You add more
      { type: 'recipient', person: 'B' },  // Randy wraps up
      { type: 'recipient', person: 'C' },  // Verdant signs off
    ];

    // Show structure preview
    document.getElementById('structure-preview').textContent = testStructure.map((s, i) =>
      `Message ${i + 1}: Person ${s.person} (${s.type})`
    ).join('\n');

    function buildPrompt() {
      const topic = 'travel';
      const isGroupChat = true;

      const topicPrompt = `THREE friends in a group chat discussing travel. All messages should be addressed to the ENTIRE GROUP. One shares travel experiences while the others react, ask questions, and make future plans together.`;

      const messagePattern = testStructure.map((s, i) =>
        `Message ${i + 1}: Person ${s.person}`
      ).join('\n');

      const groupChatNote = `This is a GROUP CHAT with 3 people:
- Person A = The SENDER (you/the main protagonist). Purple bubbles on the RIGHT.
- Person B = First recipient (friend #1). Messages on the LEFT with profile photo.
- Person C = Second recipient (friend #2). Messages on the LEFT with different profile photo.

üö® CRITICAL GROUP CHAT LANGUAGE RULES - YOU MUST FOLLOW THESE:
1. NEVER use singular "you" - ALWAYS use "you guys", "you both", "y'all", "everyone", or "we"
2. Every message should feel like it's addressed to MULTIPLE people, not just one person
3. Make statements that include everyone: "we should", "let's all", "are we", "who's down"
4. React to the GROUP, not individuals: "omg you guys", "wait both of you", "lol we're all"

WRONG examples (do NOT use these):
- "Are you free this weekend?" ‚ùå
- "What do you think?" ‚ùå
- "Don't forget your wallet" ‚ùå

CORRECT examples (USE these patterns):
- "Are you guys free this weekend?" ‚úì
- "What do y'all think?" ‚úì
- "Nobody forget their wallets lol" ‚úì
- "We should totally do that" ‚úì
- "Who's down for Sunday?" ‚úì
- "Let's all meet at 2" ‚úì
- "Omg you guys this is perfect" ‚úì`;

      const systemPrompt = `You are a conversation generator creating a realistic text message conversation between ${topicPrompt}

${groupChatNote}

CRITICAL: You must generate messages in EXACTLY this order and speaker pattern:
${messagePattern}

Rules:
- Follow the EXACT speaker pattern above - each message MUST come from the specified person
- Person A is the SENDER (you/main character) - their messages are on the RIGHT
- Person B is the FIRST RECIPIENT (friend #1) - their messages are on the LEFT
- Person C is the SECOND RECIPIENT (friend #2, only in group chats) - their messages are on the LEFT
- CRITICAL: Each person has their OWN perspective and voice. B and C should NOT say things that only A would know or say
- ALWAYS use sentence case (capitalize only the first letter of each message, not every word)
- Vary message lengths naturally: some very short (1-3 words like "Ok", "Lol", "Yeah"), some medium (5-10 words), some longer (10-20 words)
- When the SAME PERSON sends multiple messages in a row, these are CONSECUTIVE TEXTS from that person (like when someone sends multiple quick texts before getting a reply). They should NOT be responding to themselves - they are continuing their thought, adding info, or reacting to the previous speaker's message.
- CRITICAL FOR GROUP CHAT: Use group language when addressing others - say "you guys", "you both", "y'all", "everyone", or "we" instead of singular "you". This is a flowing 3-way conversation where everyone talks TO the group. Each person should react to what was LAST said by a DIFFERENT person, bringing new information or reactions to keep the conversation moving forward.
- Don't use quotation marks around messages
- Limit emojis (max 2-3 in the entire conversation)
- Messages should form a coherent, flowing conversation where each message responds to or builds on previous messages from OTHER people

Output format: Return ONLY a JSON array of ${testStructure.length} message strings in order. Example format:
["First message here", "Second message here", "Third message here"]`;

      return {
        systemPrompt,
        userPrompt: `Generate exactly ${testStructure.length} messages following the pattern. Topic: travel - specifically about Person A traveling in Tokyo while B and C ask questions and react from home. This is a 3-person group chat. Return only the JSON array.`
      };
    }

    function showPrompt() {
      const { systemPrompt, userPrompt } = buildPrompt();
      document.getElementById('prompt-content').textContent =
        `=== SYSTEM PROMPT ===\n\n${systemPrompt}\n\n=== USER PROMPT ===\n\n${userPrompt}`;
      document.getElementById('prompt-section').style.display = 'block';
    }

    async function runTest() {
      const btn = document.getElementById('test-btn');
      const resultDiv = document.getElementById('result');
      const chatPreview = document.getElementById('chat-preview');

      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>Generating...';
      resultDiv.innerHTML = '<p>Calling Llama API...</p>';
      resultDiv.className = 'result';
      chatPreview.style.display = 'none';

      try {
        const { systemPrompt, userPrompt } = buildPrompt();

        const apiUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://api.llama.com/v1/chat/completions');

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${LLAMA_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'Llama-4-Maverick-17B-128E-Instruct-FP8',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: userPrompt }
            ]
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API Error (${response.status}): ${errorText}`);
        }

        const data = await response.json();

        let responseText = '';
        if (data.completion_message && data.completion_message.content) {
          responseText = data.completion_message.content.text || data.completion_message.content;
        } else if (data.choices && data.choices[0]) {
          responseText = data.choices[0].message.content;
        }

        // Parse JSON from response
        let cleanedResponse = responseText;
        const codeBlockMatch = responseText.match(/```(?:json)?\s*([\s\S]*?)```/);
        if (codeBlockMatch) {
          cleanedResponse = codeBlockMatch[1].trim();
        }

        const jsonMatch = cleanedResponse.match(/\[[\s\S]*\]/);
        if (!jsonMatch) {
          throw new Error('Could not find JSON array in response');
        }

        const messages = JSON.parse(jsonMatch[0]);

        // Check for singular "you" violations
        const violations = [];
        messages.forEach((msg, i) => {
          const lowerMsg = msg.toLowerCase();
          // Check for singular "you" not followed by "guys", "both", "all"
          if (lowerMsg.match(/\byou\b(?!\s*(guys|both|all|two))/)) {
            // But allow "you guys", "you both", etc.
            if (!lowerMsg.includes('you guys') &&
                !lowerMsg.includes('you both') &&
                !lowerMsg.includes('you all') &&
                !lowerMsg.includes('you two') &&
                !lowerMsg.includes("y'all")) {
              violations.push(`Message ${i + 1}: "${msg}"`);
            }
          }
        });

        resultDiv.innerHTML = `
          <p><strong>‚úÖ Successfully generated ${messages.length} messages!</strong></p>
          ${violations.length > 0 ?
            `<p style="color: orange;">‚ö†Ô∏è Found ${violations.length} potential singular "you" usage(s):</p>
             <ul>${violations.map(v => `<li>${v}</li>`).join('')}</ul>` :
            `<p style="color: green;">‚úì No singular "you" violations detected!</p>`
          }
        `;

        // Render chat preview
        chatPreview.innerHTML = '';
        messages.forEach((msg, i) => {
          const person = testStructure[i].person;
          const type = testStructure[i].type;

          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.flexDirection = 'column';
          wrapper.style.alignItems = type === 'sender' ? 'flex-end' : 'flex-start';

          const label = document.createElement('div');
          label.className = 'person-label';
          label.textContent = `Person ${person}`;

          const bubble = document.createElement('div');
          bubble.className = `message ${type === 'sender' ? 'sender' : (person === 'B' ? 'recipient-b' : 'recipient-c')}`;
          bubble.textContent = msg;

          wrapper.appendChild(label);
          wrapper.appendChild(bubble);
          chatPreview.appendChild(wrapper);
        });
        chatPreview.style.display = 'flex';

      } catch (error) {
        resultDiv.innerHTML = `<p><strong>‚ùå Error:</strong> ${error.message}</p>`;
        resultDiv.className = 'result error';
      }

      btn.disabled = false;
      btn.textContent = 'üöÄ Generate Group Chat Conversation';
    }
  </script>
</body>
</html>

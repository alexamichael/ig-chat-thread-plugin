<!DOCTYPE html>
<html>
<head>
    <title>JSON Parsing Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>JSON Parsing Test Suite</h1>
    <p>Testing the improved JSON parsing logic for various API response formats.</p>
    <div id="results"></div>

    <script>
        // Copy of the parsing logic from ui.html
        function parseConversationJSON(responseText) {
            // First, try to extract JSON from markdown code blocks if present
            let cleanedResponse = responseText;
            
            // Remove markdown code block wrappers (```json ... ``` or ``` ... ```)
            const codeBlockMatch = responseText.match(/```(?:json)?\s*([\s\S]*?)```/);
            if (codeBlockMatch) {
                cleanedResponse = codeBlockMatch[1].trim();
            }
            
            const jsonMatch = cleanedResponse.match(/\[[\s\S]*\]/);
            if (!jsonMatch) {
                throw new Error('Could not find conversation array in response.');
            }

            let messages;
            try {
                // First attempt: direct parse
                messages = JSON.parse(jsonMatch[0]);
            } catch (e) {
                // Second attempt: sanitize common issues
                try {
                    let sanitized = jsonMatch[0]
                        // Remove trailing commas before ] or }
                        .replace(/,\s*([\]}])/g, '$1')
                        // Fix unescaped newlines in strings
                        .replace(/([^\\])\\n/g, '$1\\\\n')
                        // Replace actual newlines in strings with spaces
                        .replace(/"([^"]*)\n([^"]*)"/g, '"$1 $2"');
                    
                    messages = JSON.parse(sanitized);
                } catch (e2) {
                    // Third attempt: extract individual strings manually
                    try {
                        const stringMatches = jsonMatch[0].match(/"([^"\\]*(\\.[^"\\]*)*)"/g);
                        if (stringMatches && stringMatches.length > 0) {
                            messages = stringMatches.map(s => s.slice(1, -1).replace(/\\"/g, '"'));
                        } else {
                            throw e2;
                        }
                    } catch (e3) {
                        throw new Error(`Failed to parse conversation JSON: ${jsonMatch[0].substring(0, 100)}...`);
                    }
                }
            }

            if (!Array.isArray(messages) || messages.length === 0) {
                throw new Error('Invalid conversation format received.');
            }

            return messages;
        }

        // Test cases
        const testCases = [
            {
                name: "Clean JSON array",
                input: '["Hello there!", "Hey! How are you?", "Im doing great"]',
                expected: ["Hello there!", "Hey! How are you?", "Im doing great"]
            },
            {
                name: "JSON wrapped in markdown code block (```json)",
                input: '```json\n["Hello!", "Hi back!", "What\'s up?"]\n```',
                expected: ["Hello!", "Hi back!", "What's up?"]
            },
            {
                name: "JSON wrapped in markdown code block (``` only)",
                input: '```\n["Message 1", "Message 2"]\n```',
                expected: ["Message 1", "Message 2"]
            },
            {
                name: "JSON with trailing comma",
                input: '["First message", "Second message", "Third message",]',
                expected: ["First message", "Second message", "Third message"]
            },
            {
                name: "JSON with extra text before/after",
                input: 'Here is the conversation:\n["Hello!", "Hey there!"]\nHope this helps!',
                expected: ["Hello!", "Hey there!"]
            },
            {
                name: "JSON with newlines between elements",
                input: '[\n  "Message one",\n  "Message two",\n  "Message three"\n]',
                expected: ["Message one", "Message two", "Message three"]
            },
            {
                name: "JSON with escaped quotes",
                input: '["She said \\"hello\\"", "I replied \\"hi\\""]',
                expected: ['She said "hello"', 'I replied "hi"']
            },
            {
                name: "JSON with emojis",
                input: '["Hey! üëã", "What\'s up? üéâ", "Not much lol üòÇ"]',
                expected: ["Hey! üëã", "What's up? üéâ", "Not much lol üòÇ"]
            },
            {
                name: "JSON in markdown with extra explanation",
                input: 'Sure! Here\'s the conversation:\n\n```json\n["Yo!", "Hey!", "What are you up to?"]\n```\n\nLet me know if you need changes.',
                expected: ["Yo!", "Hey!", "What are you up to?"]
            },
            {
                name: "JSON with numbers in strings",
                input: '["Meet at 5pm?", "Sure, I\'ll be there by 5:30", "Cool see u then"]',
                expected: ["Meet at 5pm?", "Sure, I'll be there by 5:30", "Cool see u then"]
            },
            {
                name: "Single message array",
                input: '["Just one message here"]',
                expected: ["Just one message here"]
            },
            {
                name: "Many messages (10+)",
                input: '["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"]',
                expected: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"]
            }
        ];

        // Run tests
        const resultsDiv = document.getElementById('results');
        let passed = 0;
        let failed = 0;

        testCases.forEach((test, index) => {
            const testDiv = document.createElement('div');
            testDiv.className = 'test';
            
            try {
                const result = parseConversationJSON(test.input);
                const isEqual = JSON.stringify(result) === JSON.stringify(test.expected);
                
                if (isEqual) {
                    passed++;
                    testDiv.className += ' pass';
                    testDiv.innerHTML = `
                        <h3>‚úÖ Test ${index + 1}: ${test.name}</h3>
                        <p><strong>Result:</strong> ${result.length} messages parsed correctly</p>
                    `;
                } else {
                    failed++;
                    testDiv.className += ' fail';
                    testDiv.innerHTML = `
                        <h3>‚ùå Test ${index + 1}: ${test.name}</h3>
                        <p><strong>Expected:</strong></p>
                        <pre>${JSON.stringify(test.expected, null, 2)}</pre>
                        <p><strong>Got:</strong></p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                failed++;
                testDiv.className += ' fail';
                testDiv.innerHTML = `
                    <h3>‚ùå Test ${index + 1}: ${test.name}</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Input:</strong></p>
                    <pre>${test.input}</pre>
                `;
            }
            
            resultsDiv.appendChild(testDiv);
        });

        // Summary
        const summaryDiv = document.createElement('div');
        summaryDiv.innerHTML = `
            <h2>Summary: ${passed}/${testCases.length} tests passed</h2>
            <p>${failed > 0 ? `‚ö†Ô∏è ${failed} test(s) failed` : '‚úÖ All tests passed!'}</p>
        `;
        resultsDiv.insertBefore(summaryDiv, resultsDiv.firstChild);
    </script>
</body>
</html>

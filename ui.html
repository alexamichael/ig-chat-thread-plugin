<!DOCTYPE html>
<html>
<head>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Text', sans-serif;
      font-size: 12px;
      color: #333;
      padding: 0;
      background: #ffffff;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #1a1a1a;
    }

    .subtitle {
      font-size: 11px;
      color: #666;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 12px 16px 16px 16px;
    }

    .banner-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      width: calc(100% + 32px);
      max-width: 320px;
      height: 80px;
      margin-bottom: 12px;
      overflow: hidden;
      margin-left: -16px;
      margin-right: -16px;
      margin-top: -12px;
      background: linear-gradient(135deg, #4A5DF9 0%, #7B68EE 50%, #E040FB 100%);
    }

    .banner-wrapper img {
      display: none;
    }

    .banner-placeholder {
      color: white;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
    }

    .topic-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'SF Pro Text', sans-serif;
      color: #333;
      background: #f5f5f5;
      cursor: pointer;
      transition: all 0.15s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .topic-select:focus {
      outline: none;
      border-color: #4A5DF9;
      background-color: rgba(74, 93, 249, 0.05);
    }

    .topic-select.selected {
      border-color: #4A5DF9;
      background-color: rgba(74, 93, 249, 0.05);
    }

    .custom-topic-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'SF Pro Text', sans-serif;
      color: #333;
      background: #f5f5f5;
      resize: vertical;
      transition: all 0.15s ease;
      box-sizing: border-box;
      min-height: 38px;
      max-height: 62px;
      line-height: 1.4;
    }

    .custom-topic-input:focus {
      outline: none;
      border-color: #4A5DF9;
      background: rgba(74, 93, 249, 0.05);
    }

    .custom-topic-input::placeholder {
      color: #888;
      font-style: italic;
    }

    .custom-topic-input.active {
      border-color: #4A5DF9;
      background: rgba(74, 93, 249, 0.05);
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .custom-topic-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .custom-topic-row .custom-topic-input {
      flex: 1;
    }

    .custom-topic-row .generate-btn {
      flex-shrink: 0;
      width: 80px;
      padding: 10px 16px;
      min-width: auto;
    }

    /* Slider styles for conversation length */
    .slider-container {
      width: 100%;
    }

    .slider-row {
      display: flex;
      align-items: center;
    }

    .slider-track-wrapper {
      flex: 1;
      position: relative;
    }

    .slider-input {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #4A5DF9;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .slider-input::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #4A5DF9;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
    }

    .slider-label {
      font-size: 11px;
      color: #666;
      font-weight: 500;
    }

    .slider-label:first-child {
      text-align: left;
    }

    .slider-label:nth-child(2) {
      text-align: center;
    }

    .slider-label:last-child {
      text-align: right;
    }

    button {
      flex: 1;
      background: #4A5DF9;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #3a4dc9;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.secondary {
      background: #f0f0f0;
      color: #333;
    }

    button.secondary:hover {
      background: #e0e0e0;
    }

    .status-bar {
      display: none;
      padding: 10px 16px;
      font-size: 11px;
      text-align: center;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      border-top: 1px solid rgba(0,0,0,0.1);
      background: #ffffff;
    }

    .status-bar.success {
      display: block;
      background: linear-gradient(#d4edda, #d4edda), #ffffff;
      color: #155724;
    }

    .status-bar.error {
      display: block;
      background: linear-gradient(#f8d7da, #f8d7da), #ffffff;
      color: #721c24;
    }

    .status-bar.info {
      display: block;
      background: linear-gradient(#e8ebfe, #e8ebfe), #ffffff;
      color: #4A5DF9;
    }

    .divider {
      height: 1px;
      background: #e0e0e0;
      margin: 4px 0;
    }

    .info-text {
      font-size: 10px;
      color: #888;
      font-style: italic;
    }

    .api-link {
      color: #18A0FB;
      text-decoration: none;
      font-size: 10px;
    }

    .api-link:hover {
      text-decoration: underline;
    }

    .loading-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #888;
    }

    .empty-state .icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .tagline {
      text-align: center;
      font-size: 11px;
      color: #888;
      margin-top: 8px;
      padding-bottom: 16px;
    }

    .tagline a {
      color: #4A5DF9;
      text-decoration: none;
    }

    .tagline a:hover {
      text-decoration: underline;
    }

    .version-tag {
      font-size: 10px;
      color: #aaa;
      display: block;
      margin-top: 4px;
    }

    /* Chat Type Radio Buttons */
    .chat-type-row {
      display: flex;
      gap: 16px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 12px;
      color: #333;
    }

    .radio-label input[type="radio"] {
      display: none;
    }

    .radio-custom {
      width: 16px;
      height: 16px;
      border: 2px solid #ccc;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .radio-label input[type="radio"]:checked + .radio-custom {
      border-color: #4A5DF9;
    }

    .radio-label input[type="radio"]:checked + .radio-custom::after {
      content: '';
      width: 8px;
      height: 8px;
      background: #4A5DF9;
      border-radius: 50%;
    }

    .radio-text {
      font-weight: 500;
    }

    /* Group Size Dropdown */
    .group-size-container {
      margin-top: 8px;
    }

    .dropdown-label {
      display: block;
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }

    .group-size-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'SF Pro Text', sans-serif;
      color: #333;
      background: #f5f5f5;
      cursor: pointer;
      transition: all 0.15s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .group-size-select:focus {
      outline: none;
      border-color: #4A5DF9;
      background-color: rgba(74, 93, 249, 0.05);
    }

    /* Chat Flair Slider Styles */
    .slider-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider-track-wrapper {
      flex: 1;
      position: relative;
    }

    .slider-input {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: linear-gradient(to right, #4A5DF9 0%, #4A5DF9 var(--slider-progress, 0%), #e0e0e0 var(--slider-progress, 0%), #e0e0e0 100%);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #4A5DF9;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform 0.15s ease;
    }

    .slider-input::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .slider-input::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #4A5DF9;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .slider-label {
      font-size: 10px;
      color: #888;
      text-align: center;
      width: 40px;
    }

    .slider-label:first-child {
      text-align: left;
    }

    .slider-label:last-child {
      text-align: right;
    }

    .slider-value {
      display: none;
    }

    .subsection-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .gradient-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'SF Pro Text', sans-serif;
      color: #333;
      background: #f5f5f5;
      cursor: pointer;
      transition: all 0.15s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .gradient-select:focus {
      outline: none;
      border-color: #4A5DF9;
      background-color: rgba(74, 93, 249, 0.05);
    }

    /* Checkbox Dropdown Styles */
    .checkbox-dropdown {
      position: relative;
    }

    .checkbox-dropdown-toggle {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'SF Pro Text', sans-serif;
      color: #333;
      background: #f5f5f5;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .checkbox-dropdown-toggle:hover {
      border-color: #ccc;
    }

    .dropdown-arrow {
      font-size: 8px;
      color: #666;
      transition: transform 0.15s ease;
    }

    .checkbox-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .checkbox-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-top: 4px;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-size: 12px;
    }

    .checkbox-option:hover {
      background: rgba(74, 93, 249, 0.05);
    }

    .checkbox-option:first-child {
      border-radius: 6px 6px 0 0;
    }

    .checkbox-option:last-child {
      border-radius: 0 0 6px 6px;
    }

    .checkbox-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #4A5DF9;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Banner Placeholder -->
    <div class="banner-wrapper">
      <img id="header-img" alt="IG Chat Gen" />
      <span class="banner-placeholder">IG Direct Chat Thread</span>
    </div>

    <!-- Chat Type Selection -->
    <div class="section">
      <span class="section-label">Chat type</span>
      <div class="chat-type-row">
        <label class="radio-label">
          <input type="radio" name="chat-type" value="1:1" checked>
          <span class="radio-custom"></span>
          <span class="radio-text">1:1 Chat</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="chat-type" value="group">
          <span class="radio-custom"></span>
          <span class="radio-text">Group Chat</span>
        </label>
      </div>
      <div id="group-size-container" class="group-size-container" style="display: none;">
        <label class="dropdown-label">Number of people</label>
        <select id="group-size-select" class="group-size-select">
          <option value="3" selected>3 people</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Conversation Topic Section -->
    <div class="section">
      <span class="section-label">Conversation topic</span>
      <select id="topic-select" class="topic-select">
        <option value="" disabled selected>Choose a topic...</option>
        <option value="sports">üèÄ Sports</option>
        <option value="highschool">üéí High School</option>
        <option value="genz">‚ú® Gen-Z</option>
        <option value="travel">‚úàÔ∏è Travel</option>
        <option value="events">üéâ Events</option>
        <option value="business">üíº Business</option>
        <option value="creators">üé¨ Creators</option>
        <option value="family">üë®‚Äçüë©‚Äçüëß Friends & Family</option>
      </select>
    </div>

    <!-- Custom Topic -->
    <div class="section">
      <span class="section-label">Custom topic</span>
      <div class="custom-topic-row">
        <textarea
          id="custom-topic-input"
          class="custom-topic-input"
          placeholder="Describe topic"
          rows="1"
        ></textarea>
        <button id="generate-btn" class="generate-btn" disabled>Generate</button>
      </div>
    </div>

    <!-- Conversation Length -->
    <div class="section">
      <span class="section-label">Conversation length</span>
      <div class="slider-container">
        <div class="slider-row">
          <div class="slider-track-wrapper">
            <input type="range" id="length-slider" class="slider-input" min="0" max="100" step="50" value="100">
            <div class="slider-labels">
              <span class="slider-label">Short</span>
              <span class="slider-label">Medium</span>
              <span class="slider-label">Long</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Chat Flair Section -->
    <div class="section">
      <span class="section-label">Chat flair</span>
      <div class="slider-container">
        <span class="subsection-label">üòä Emojis</span>
        <div class="slider-row">
          <div class="slider-track-wrapper">
            <input type="range" id="reactions-slider" class="slider-input" min="0" max="100" step="50" value="0">
            <div class="slider-labels">
              <span class="slider-label">None</span>
              <span class="slider-label">Some</span>
              <span class="slider-label">Lots</span>
            </div>
          </div>
        </div>
      </div>
      <div class="slider-container" style="margin-top: 12px;">
        <span class="subsection-label">üéâ Stickers</span>
        <div class="slider-row">
          <div class="slider-track-wrapper">
            <input type="range" id="stickers-slider" class="slider-input" min="0" max="100" step="50" value="0">
            <div class="slider-labels">
              <span class="slider-label">None</span>
              <span class="slider-label">Some</span>
              <span class="slider-label">Lots</span>
            </div>
          </div>
        </div>
      </div>
      <div class="slider-container" style="margin-top: 12px;">
        <span class="subsection-label">üåà Gradient</span>
        <select id="gradient-select" class="gradient-select" style="margin-top: 4px;">
          <option value="none" selected>No gradient</option>
          <option value="gradient">Gradient</option>
        </select>
      </div>
      <div class="slider-container" style="margin-top: 12px;">
        <span class="subsection-label">üì∑ Media</span>
        <select id="media-select" class="gradient-select" style="margin-top: 4px;">
          <option value="none" selected>None</option>
          <option value="media-chat">Media chat</option>
          <option value="reels">Reels</option>
          <option value="both">Both</option>
        </select>
      </div>
    </div>

    <div class="button-row">
      <button id="diagnostics-btn" class="secondary">üîç Run Diagnostics</button>
    </div>

    <div class="tagline">
      <span>Questions or feedback? Reach out to <a href="https://www.internalfb.com/profile/view/6709430" target="_blank">Alexa Michael</a></span>
      <span class="version-tag">v3.2</span>
    </div>
  </div>

  <div id="status-bar" class="status-bar"></div>

<script src="headerImage.js"></script>
  <script>
    // Set header image from external file
    document.getElementById('header-img').src = HEADER_IMAGE;

    // ============================================================================
    // EMBEDDED LLAMA API KEY
    // ============================================================================
    const LLAMA_API_KEY = 'LLM|1428288808968195|FSBSdnVSLJIadzuqqUCP-sjT91U';

    let selectedTopic = null;
    let customTopic = null;
    let currentStructure = null;
    let isGroupChat = false;
    let participants = 2;
    let userSelectedChatType = null;

    // DOM elements
    const topicSelect = document.getElementById('topic-select');
    const generateBtn = document.getElementById('generate-btn');
    const statusBar = document.getElementById('status-bar');
    const customTopicInput = document.getElementById('custom-topic-input');
    const chatTypeRadios = document.querySelectorAll('input[name="chat-type"]');
    const groupSizeContainer = document.getElementById('group-size-container');
    const groupSizeSelect = document.getElementById('group-size-select');

    // Chat type radio button handlers
    chatTypeRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        const selectedValue = e.target.value;
        userSelectedChatType = selectedValue;

        if (selectedValue === 'group') {
          groupSizeContainer.style.display = 'block';
          isGroupChat = true;
          participants = parseInt(groupSizeSelect.value);
        } else {
          groupSizeContainer.style.display = 'none';
          isGroupChat = false;
          participants = 2;
        }

        // Capture current gradient state BEFORE making changes
        const gradientStateBefore = gradientSelect.value;

        // Send message to plugin to toggle the component property
        parent.postMessage({
          pluginMessage: {
            type: 'toggle-chat-type',
            isGroupChat: isGroupChat,
            participants: participants
          }
        }, '*');

        // Restore gradient state after a delay to ensure toggle completes
        setTimeout(() => {
          if (gradientStateBefore === 'gradient') {
            parent.postMessage({ pluginMessage: { type: 'apply-gradient' } }, '*');
          } else {
            parent.postMessage({ pluginMessage: { type: 'remove-gradient' } }, '*');
          }
        }, 500);
      });
    });

    // Group size dropdown handler
    groupSizeSelect.addEventListener('change', (e) => {
      participants = parseInt(e.target.value);

      parent.postMessage({
        pluginMessage: {
          type: 'update-participants',
          participants: participants
        }
      }, '*');
    });

    // Get length slider reference
    const lengthSlider = document.getElementById('length-slider');

    /**
     * Get the target height based on length slider setting
     * Short (0) = 917px
     * Medium (50) = 1064px
     * Long (100) = 2200px
     */
    function getTargetHeight() {
      const sliderValue = parseInt(lengthSlider.value);

      if (sliderValue === 0) {
        return 917;
      } else if (sliderValue === 50) {
        return 1064;
      } else {
        return 2200; // Long - max 2200px
      }
    }

    /**
     * Get the max number of messages based on length slider setting
     * Used to limit what we send to LLM when generating new conversations
     * Long (100) = ~2200px worth of messages
     * Medium (50) = ~1064px
     * Short (0) = ~917px
     *
     * We estimate ~80px average per message bubble
     * Short: 917px / 80 ‚âà 11 messages (cap at 8)
     * Medium: 1064px / 80 ‚âà 13 messages
     * Long: 2200px / 80 ‚âà 27 messages
     */
    function getMaxMessagesForLength(structureLength) {
      const sliderValue = parseInt(lengthSlider.value);

      if (sliderValue === 100) {
        // Long - up to 27 messages for 2200px
        return Math.min(27, structureLength);
      } else if (sliderValue === 50) {
        // Medium - approximately half
        return Math.min(Math.ceil(structureLength / 2), 13);
      } else {
        // Short - max 8 messages
        return Math.min(8, structureLength);
      }
    }

    /**
     * Limit the structure array based on length setting
     */
    function getLimitedStructure(structure) {
      const maxMessages = getMaxMessagesForLength(structure.length);
      return structure.slice(0, maxMessages);
    }

    /**
     * Length slider change handler
     * Works independently of topic selection - adjusts existing conversation visibility
     * Does NOT call API - only shows/hides chat blocks based on height
     */
    lengthSlider.addEventListener('change', () => {
      // Capture current gradient state BEFORE making changes
      const gradientStateBefore = gradientSelect.value;

      showStatus('Adjusting conversation length...', 'info');

      // Always send adjust-length to Figma - works on existing conversation
      parent.postMessage({
        pluginMessage: {
          type: 'adjust-length',
          targetHeight: getTargetHeight()
        }
      }, '*');

      // Restore gradient state after a delay to ensure adjust completes
      setTimeout(() => {
        if (gradientStateBefore === 'gradient') {
          parent.postMessage({ pluginMessage: { type: 'apply-gradient' } }, '*');
        } else {
          parent.postMessage({ pluginMessage: { type: 'remove-gradient' } }, '*');
        }
      }, 500);
    });

    // Topic prompts for Llama - 2 person version
    const topicPrompts2Person = {
      sports: "two friends who are passionate sports fans discussing recent games, players, and upcoming matches. They use casual sports terminology and share excitement about their team.",
      highschool: "two high school students texting about school, homework, classes, social events, and typical teenage life. Use casual teen language, abbreviations, and relatable school scenarios.",
      genz: "two Gen-Z friends using current internet slang and culture references. Include terms like 'no cap', 'fr', 'lowkey', 'slay', 'hits different', 'living rent free', 'ate that', 'understood the assignment', etc.",
      travel: "two friends where one is traveling and sharing their experiences while the other responds with excitement and questions. Include mentions of places, food, and travel experiences.",
      events: "two friends planning to attend or discussing an event like a party, concert, or social gathering. Cover logistics, excitement, outfits, and who else is attending.",
      business: "two professional colleagues discussing work matters like meetings, projects, deadlines, and office dynamics. Use professional but friendly business language.",
      creators: "two content creators discussing videos, engagement metrics, editing, collaborations, brand deals, and the creator economy. Reference platforms like TikTok, Instagram, YouTube.",
      family: "family members or close friends catching up about family gatherings, relatives, dinner plans, health check-ins, and everyday life updates. Warm and caring tone."
    };

    // Topic prompts for Llama - 3 person GROUP CHAT version
    const topicPrompts3Person = {
      sports: "THREE friends in a group chat who are passionate sports fans. All messages should be addressed to the ENTIRE GROUP, not just one person. They discuss games, players, and matches while reacting to each other's takes and building excitement together.",
      highschool: "THREE high school students in a group chat texting about school life. All messages should be addressed to the ENTIRE GROUP. They share homework struggles, gossip, and make plans together using casual teen language.",
      genz: "THREE Gen-Z friends in a group chat using current slang. All messages should be addressed to the ENTIRE GROUP. They hype each other up, react to shared content, and use terms like 'no cap', 'fr', 'lowkey', 'slay', etc.",
      travel: "THREE friends in a group chat discussing travel. All messages should be addressed to the ENTIRE GROUP. One shares travel experiences while the others react, ask questions, and make future plans together.",
      events: "THREE friends in a group chat planning an event together. All messages should be addressed to the ENTIRE GROUP. They coordinate logistics, discuss outfits, and build excitement as a trio.",
      business: "THREE colleagues in a work group chat. All messages should be addressed to the ENTIRE GROUP. They coordinate on projects, share updates, and align on deliverables together.",
      creators: "THREE content creators in a group chat. All messages should be addressed to the ENTIRE GROUP. They share ideas, react to each other's content, and discuss collaborations as a team.",
      family: "THREE family members or close friends in a group chat. All messages should be addressed to the ENTIRE GROUP. They share updates, coordinate plans, and check in on everyone with warmth."
    };

    // Topic dropdown selection - now generates immediately
    topicSelect.addEventListener('change', async () => {
      selectedTopic = topicSelect.value;
      topicSelect.classList.add('selected');
      customTopic = null;
      customTopicInput.value = '';
      customTopicInput.classList.remove('active');
      updateGenerateButton();

      // Clear any existing reactions and stickers
      parent.postMessage({
        pluginMessage: { type: 'remove-reactions' }
      }, '*');
      parent.postMessage({
        pluginMessage: { type: 'remove-stickers' }
      }, '*');

      // Reset sliders to "None"
      reactionsSlider.value = 0;
      stickersSlider.value = 0;
      updateSliderVisual();
      updateStickersSliderVisual();

      // Auto-generate when a topic is selected
      if (selectedTopic && currentStructure && currentStructure.length > 0) {
        // Capture current gradient state BEFORE making changes
        const gradientStateBefore = gradientSelect.value;

        generateBtn.disabled = true;
        showStatus('Generating conversation...', 'info');

        try {
          const limitedStructure = getLimitedStructure(currentStructure);
          const maxMessages = getMaxMessagesForLength(currentStructure.length);
          const messages = await generateConversationWithLlama(selectedTopic, limitedStructure, false);

          parent.postMessage({
            pluginMessage: {
              type: 'populate-conversation',
              messages: messages,
              maxMessages: maxMessages,
              targetHeight: getTargetHeight()
            }
          }, '*');

          // Restore gradient state after a delay to ensure populate completes
          setTimeout(() => {
            if (gradientStateBefore === 'gradient') {
              parent.postMessage({ pluginMessage: { type: 'apply-gradient' } }, '*');
            } else {
              parent.postMessage({ pluginMessage: { type: 'remove-gradient' } }, '*');
            }
          }, 500);
        } catch (error) {
          showStatus(`Error: ${error.message}`, 'error');
          generateBtn.disabled = false;
        }
      }
    });

    // Custom topic input handling
    customTopicInput.addEventListener('input', () => {
      const value = customTopicInput.value.trim();
      if (value.length > 0) {
        topicSelect.value = '';
        topicSelect.classList.remove('selected');
        selectedTopic = null;
        customTopic = value;
        customTopicInput.classList.add('active');
      } else {
        customTopic = null;
        customTopicInput.classList.remove('active');
      }
      updateGenerateButton();
    });

    customTopicInput.addEventListener('focus', () => {
      if (customTopicInput.value.trim().length > 0) {
        customTopicInput.classList.add('active');
      }
    });

    function updateGenerateButton() {
      // Generate button is only enabled when custom topic has text AND structure is available
      const hasCustomTopic = customTopic && customTopic.length > 0;
      generateBtn.disabled = !(hasCustomTopic && currentStructure && currentStructure.length > 0);
    }

    function requestStructureAnalysis() {
      parent.postMessage({
        pluginMessage: { type: 'analyze-structure' }
      }, '*');
    }

    const API_TIMEOUT_MS = 30000;

    class LlamaAPIError extends Error {
      constructor(message, type, details = null) {
        super(message);
        this.name = 'LlamaAPIError';
        this.type = type;
        this.details = details;
      }
    }

    async function fetchWithTimeout(url, options, timeoutMs = API_TIMEOUT_MS) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new LlamaAPIError(
            `Request timed out after ${timeoutMs / 1000} seconds. Please try again.`,
            'timeout'
          );
        }
        throw error;
      }
    }

    function parseAPIError(status, errorText) {
      switch (status) {
        case 401:
          return new LlamaAPIError('Invalid API key. Please check your Llama API key.', 'auth', errorText);
        case 403:
          return new LlamaAPIError('Access forbidden. Your API key may not have permission.', 'auth', errorText);
        case 429:
          return new LlamaAPIError('Rate limit exceeded. Please wait and try again.', 'rate_limit', errorText);
        case 500:
        case 502:
        case 503:
        case 504:
          return new LlamaAPIError('Llama API server error. Please try again.', 'server', errorText);
        default:
          return new LlamaAPIError(`API error (${status}): ${errorText.substring(0, 100)}`, 'unknown', errorText);
      }
    }

    async function generateConversationWithLlama(topic, structure, isCustomTopic = false) {
      let topicPrompt;
      if (isCustomTopic) {
        topicPrompt = isGroupChat
          ? `THREE friends in a group chat discussing: ${topic}. All messages should be addressed to the ENTIRE GROUP. They engage naturally with each other about this topic, sharing thoughts, reactions, and building on each other's points.`
          : `two friends texting about: ${topic}. They engage naturally with each other about this topic, sharing thoughts, reactions, and building on each other's points with casual, authentic messaging style.`;
      } else {
        topicPrompt = isGroupChat ? topicPrompts3Person[topic] : topicPrompts2Person[topic];
      }

      const messagePattern = structure.map((s, i) => {
        return `Message ${i + 1}: Person ${s.person}`;
      }).join('\n');

      const groupChatNote = isGroupChat
          ? `This is a GROUP CHAT with 3 people:
- Person A = The SENDER (you/the main protagonist). Purple bubbles on the RIGHT.
- Person B = First recipient (friend #1). Messages on the LEFT with profile photo.
- Person C = Second recipient (friend #2). Messages on the LEFT with different profile photo.

üö® CRITICAL GROUP CHAT LANGUAGE RULES - YOU MUST FOLLOW THESE:
1. NEVER use singular "you" - ALWAYS use "you guys", "you both", "y'all", "everyone", or "we"
2. Every message should feel like it's addressed to MULTIPLE people, not just one person
3. Make statements that include everyone: "we should", "let's all", "are we", "who's down"
4. React to the GROUP, not individuals: "omg you guys", "wait both of you", "lol we're all"

WRONG examples (do NOT use these):
- "Are you free this weekend?" ‚ùå
- "What do you think?" ‚ùå
- "Don't forget your wallet" ‚ùå

CORRECT examples (USE these patterns):
- "Are you guys free this weekend?" ‚úì
- "What do y'all think?" ‚úì
- "Nobody forget their wallets lol" ‚úì
- "We should totally do that" ‚úì
- "Who's down for Sunday?" ‚úì
- "Let's all meet at 2" ‚úì
- "Omg you guys this is perfect" ‚úì`
          : `This is a 1:1 chat between Person A (sender/you) and Person B (recipient/the other person).`;

      const systemPrompt = `You are a conversation generator creating a realistic text message conversation between ${topicPrompt}

${groupChatNote}

CRITICAL: You must generate messages in EXACTLY this order and speaker pattern:
${messagePattern}

Rules:
- Follow the EXACT speaker pattern above - each message MUST come from the specified person
- Person A is the SENDER (you/main character) - their messages are on the RIGHT
- Person B is the FIRST RECIPIENT (friend #1) - their messages are on the LEFT
- Person C is the SECOND RECIPIENT (friend #2, only in group chats) - their messages are on the LEFT
- CRITICAL: Each person has their OWN perspective and voice. B and C should NOT say things that only A would know or say
- ALWAYS use sentence case (capitalize only the first letter of each message, not every word)
- Vary message lengths naturally: some very short (1-3 words like "Ok", "Lol", "Yeah"), some medium (5-10 words), some longer (10-20 words)
- When the SAME PERSON sends multiple messages in a row, these are CONSECUTIVE TEXTS from that person (like when someone sends multiple quick texts before getting a reply). They should NOT be responding to themselves - they are continuing their thought, adding info, or reacting to the previous speaker's message.
- ${isGroupChat ? 'CRITICAL FOR GROUP CHAT: Use group language when addressing others - say "you guys", "you both", "y\'all", "everyone", or "we" instead of singular "you". This is a flowing 3-way conversation where everyone talks TO the group. Each person should react to what was LAST said by a DIFFERENT person, bringing new information or reactions to keep the conversation moving forward.' : 'Keep it authentic to how people actually text'}
- Don't use quotation marks around messages
- Limit emojis (max 2-3 in the entire conversation)
- Messages should form a coherent, flowing conversation where each message responds to or builds on previous messages from OTHER people

Output format: Return ONLY a JSON array of ${structure.length} message strings in order. Example format:
["First message here", "Second message here", "Third message here"]`;

      const userPrompt = `Generate exactly ${structure.length} messages following the pattern. Topic: ${topic}. ${isGroupChat ? 'This is a 3-person group chat.' : ''} Return only the JSON array.`;

      try {
        const apiUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://api.llama.com/v1/chat/completions');

        const response = await fetchWithTimeout(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${LLAMA_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'Llama-4-Maverick-17B-128E-Instruct-FP8',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: userPrompt }
            ]
          })
        });

        if (!response.ok) {
          let errorText = '';
          try {
            errorText = await response.text();
          } catch (e) {
            errorText = 'Unable to read error response';
          }
          throw parseAPIError(response.status, errorText);
        }

        let data;
        try {
          data = await response.json();
        } catch (e) {
          throw new LlamaAPIError('Failed to parse API response.', 'parse', e.message);
        }

        let responseText = '';
        if (data.completion_message && data.completion_message.content) {
          responseText = data.completion_message.content.text || data.completion_message.content;
        } else if (data.choices && data.choices[0]) {
          responseText = data.choices[0].message.content;
        } else if (data.error) {
          throw new LlamaAPIError(`Llama API error: ${data.error.message || data.error}`, 'server', data.error);
        }

        if (!responseText) {
          throw new LlamaAPIError('Empty response from Llama API.', 'parse', JSON.stringify(data));
        }

        let cleanedResponse = responseText;
        const codeBlockMatch = responseText.match(/```(?:json)?\s*([\s\S]*?)```/);
        if (codeBlockMatch) {
          cleanedResponse = codeBlockMatch[1].trim();
        }

        const jsonMatch = cleanedResponse.match(/\[[\s\S]*\]/);
        if (!jsonMatch) {
          console.error('Raw API response:', responseText);
          throw new LlamaAPIError('Could not find conversation array in response.', 'parse', responseText);
        }

        let messages;
        try {
          messages = JSON.parse(jsonMatch[0]);
        } catch (e) {
          try {
            let sanitized = jsonMatch[0]
              .replace(/,\s*([\]}])/g, '$1')
              .replace(/([^\\])\\n/g, '$1\\\\n')
              .replace(/"([^"]*)\n([^"]*)"/g, '"$1 $2"');
            messages = JSON.parse(sanitized);
          } catch (e2) {
            try {
              const stringMatches = jsonMatch[0].match(/"([^"\\]*(\\.[^"\\]*)*)"/g);
              if (stringMatches && stringMatches.length > 0) {
                messages = stringMatches.map(s => s.slice(1, -1).replace(/\\"/g, '"'));
              } else {
                throw e2;
              }
            } catch (e3) {
              console.error('Failed to parse JSON. Raw match:', jsonMatch[0]);
              throw new LlamaAPIError(`Failed to parse conversation JSON. API returned: ${jsonMatch[0].substring(0, 200)}...`, 'parse', jsonMatch[0]);
            }
          }
        }

        if (!Array.isArray(messages) || messages.length === 0) {
          throw new LlamaAPIError('Invalid conversation format received.', 'parse', JSON.stringify(messages));
        }

        return messages.map(text => {
          const str = String(text).trim();
          if (str.length === 0) return str;
          return str.charAt(0).toUpperCase() + str.slice(1);
        });

      } catch (error) {
        console.error('Llama API error:', error);

        if (error instanceof LlamaAPIError) {
          throw error;
        }

        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          throw new LlamaAPIError('Network error. Please check your internet connection.', 'network', error.message);
        }

        if (error.message && error.message.includes('corsproxy')) {
          throw new LlamaAPIError('CORS proxy service unavailable. Please try again later.', 'network', error.message);
        }

        throw new LlamaAPIError(error.message || 'An unexpected error occurred.', 'unknown', error);
      }
    }

    // Generate button click handler
    generateBtn.addEventListener('click', async () => {
      const hasTopicSelected = selectedTopic || (customTopic && customTopic.length > 0);
      if (!hasTopicSelected || !currentStructure) return;

      // Capture current gradient state BEFORE making changes
      const gradientStateBefore = gradientSelect.value;

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<span class="loading-spinner"></span>';
      showStatus('Analyzing structure and generating conversation...', 'info');

      try {
        const topicToUse = customTopic || selectedTopic;
        const isCustom = !!customTopic;
        const limitedStructure = getLimitedStructure(currentStructure);
        const maxMessages = getMaxMessagesForLength(currentStructure.length);
        const messages = await generateConversationWithLlama(topicToUse, limitedStructure, isCustom);

        parent.postMessage({
          pluginMessage: {
            type: 'populate-conversation',
            messages: messages,
            maxMessages: maxMessages,
            targetHeight: getTargetHeight()
          }
        }, '*');

        // Restore gradient state after a delay to ensure populate completes
        setTimeout(() => {
          if (gradientStateBefore === 'gradient') {
            parent.postMessage({ pluginMessage: { type: 'apply-gradient' } }, '*');
          } else {
            parent.postMessage({ pluginMessage: { type: 'remove-gradient' } }, '*');
          }
        }, 500);
      } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate';
      }
    });

    // Handle messages from plugin
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'structure-analyzed') {
        currentStructure = msg.structure;
        isGroupChat = msg.isGroupChat || false;
        participants = msg.participants || 2;
        updateGenerateButton();

        if (userSelectedChatType === null) {
          const oneToOneRadio = document.querySelector('input[name="chat-type"][value="1:1"]');
          const groupRadio = document.querySelector('input[name="chat-type"][value="group"]');

          if (isGroupChat) {
            groupRadio.checked = true;
            groupSizeContainer.style.display = 'block';
            groupSizeSelect.value = String(participants);
          } else {
            oneToOneRadio.checked = true;
            groupSizeContainer.style.display = 'none';
          }
        }

        const chatType = isGroupChat ? 'üë• Group Chat (3 people)' : 'üí¨ 1:1 Chat';
        showStatus(`Found ${msg.totalBubbles} bubbles ‚Äî ${chatType}`, 'info');
      } else if (msg.type === 'diagnostics-complete') {
        showStatus(msg.message, 'success');
        if (msg.reactionRelated && msg.reactionRelated.length > 0) {
          console.log('[UI] Reaction-related components found:', msg.reactionRelated);
        }
      } else if (msg.type === 'success') {
        showStatus(msg.message || 'Conversation generated successfully!', 'success');
        generateBtn.textContent = 'Generate';
        updateGenerateButton();
      } else if (msg.type === 'error') {
        showStatus(msg.message || 'An error occurred', 'error');
        generateBtn.textContent = 'Generate';
        updateGenerateButton();

        if (msg.message && msg.message.includes('select')) {
          currentStructure = null;
          updateGenerateButton();
        }
      }
    };

    function showStatus(message, type) {
      statusBar.textContent = message;
      statusBar.className = 'status-bar ' + type;
    }

    requestStructureAnalysis();

    // Reactions slider handler
    const reactionsSlider = document.getElementById('reactions-slider');
    const reactionsValue = document.getElementById('reactions-value');

    function updateSliderVisual() {
      const value = parseInt(reactionsSlider.value);
      const progress = (value / 100) * 100;
      reactionsSlider.style.setProperty('--slider-progress', `${progress}%`);
    }

    reactionsSlider.addEventListener('input', updateSliderVisual);

    reactionsSlider.addEventListener('change', () => {
      const value = parseInt(reactionsSlider.value);
      // Map slider values: 0=None, 50=Some (25%), 100=Lots (50%)
      const percentage = value === 0 ? 0 : (value === 50 ? 25 : 50);
      if (percentage > 0) {
        parent.postMessage({
          pluginMessage: {
            type: 'apply-reactions',
            percentage: percentage
          }
        }, '*');
        showStatus(`Applying reactions...`, 'info');
      } else {
        parent.postMessage({
          pluginMessage: {
            type: 'remove-reactions'
          }
        }, '*');
        showStatus('Removing reactions...', 'info');
      }
    });

    // Initialize slider visual
    updateSliderVisual();

    // Stickers slider handler
    const stickersSlider = document.getElementById('stickers-slider');
    const stickersValue = document.getElementById('stickers-value');

    function updateStickersSliderVisual() {
      const value = parseInt(stickersSlider.value);
      const progress = (value / 100) * 100;
      stickersSlider.style.setProperty('--slider-progress', `${progress}%`);
    }

    stickersSlider.addEventListener('input', updateStickersSliderVisual);

    stickersSlider.addEventListener('change', () => {
      const value = parseInt(stickersSlider.value);
      // Map slider values: 0=None, 50=Some (25%), 100=Lots (50%)
      const percentage = value === 0 ? 0 : (value === 50 ? 25 : 50);
      if (percentage > 0) {
        parent.postMessage({
          pluginMessage: {
            type: 'apply-stickers',
            percentage: percentage
          }
        }, '*');
        showStatus(`Applying stickers...`, 'info');
      } else {
        parent.postMessage({
          pluginMessage: {
            type: 'remove-stickers'
          }
        }, '*');
        showStatus('Removing stickers...', 'info');
      }
    });

    // Initialize stickers slider visual
    updateStickersSliderVisual();

    // Gradient dropdown handler
    const gradientSelect = document.getElementById('gradient-select');

    // Helper function to apply current gradient setting after text chat updates
    function applyCurrentGradientSetting() {
      const value = gradientSelect.value;
      if (value === 'gradient') {
        parent.postMessage({
          pluginMessage: { type: 'apply-gradient' }
        }, '*');
      } else {
        parent.postMessage({
          pluginMessage: { type: 'remove-gradient' }
        }, '*');
      }
    }

    gradientSelect.addEventListener('change', () => {
      const value = gradientSelect.value;
      if (value === 'gradient') {
        parent.postMessage({
          pluginMessage: { type: 'apply-gradient' }
        }, '*');
        showStatus('Applying gradient...', 'info');
      } else {
        parent.postMessage({
          pluginMessage: { type: 'remove-gradient' }
        }, '*');
        showStatus('Removing gradient...', 'info');
      }
    });

    // Media dropdown handler
    const mediaSelect = document.getElementById('media-select');

    mediaSelect.addEventListener('change', () => {
      const value = mediaSelect.value;

      if (value === 'none') {
        // Remove all media content
        parent.postMessage({
          pluginMessage: {
            type: 'remove-media-chat'
          }
        }, '*');
        showStatus('Removing media content...', 'info');
      } else if (value === 'media-chat') {
        // Apply Media chat with "Some" behavior (25%)
        parent.postMessage({
          pluginMessage: {
            type: 'apply-media-chat',
            percentage: 25,
            mediaTypes: ['media-chat']
          }
        }, '*');
        showStatus('Applying Media chat...', 'info');
      } else if (value === 'reels') {
        // Apply Reels with "Some" behavior (25%)
        parent.postMessage({
          pluginMessage: {
            type: 'apply-media-chat',
            percentage: 25,
            mediaTypes: ['reels']
          }
        }, '*');
        showStatus('Applying Reels...', 'info');
      } else if (value === 'both') {
        // Apply both Media chat and Reels with "Some" behavior (25%)
        parent.postMessage({
          pluginMessage: {
            type: 'apply-media-chat',
            percentage: 25,
            mediaTypes: ['media-chat', 'reels']
          }
        }, '*');
        showStatus('Applying Media chat and Reels...', 'info');
      }
    });

    // Diagnostics button handler
    document.getElementById('diagnostics-btn').addEventListener('click', () => {
      showStatus('Running diagnostics... Check Figma console for details', 'info');
      parent.postMessage({
        pluginMessage: { type: 'run-diagnostics' }
      }, '*');
    });

    window.addEventListener('focus', () => {
      requestStructureAnalysis();
    });
  </script>
</body>
</html>
